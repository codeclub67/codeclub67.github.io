<html>
<!-- see https://stackoverflow.com/questions/71345053/get-pixel-data-of-a-png-without-drawing-it-on-a-canvas -->
<body>
<img src="ambient-letters.png" alt="astro-pi colour palette">
<br>
<input id="upload" type="file" accept="image/png"><br>
image = [
<table>
  <tbody id="table">
  </tbody>
</table>]
<br>
<table id="render">
</table>

<!-- source: https://github.com/photopea/UPNG.js -->
<script src="lib/UPNG.js"></script>
<script>

const pal = [0xffffff, 0x696969, 0x000000, 0x6495ed, 0x0000cd, 0x191970, 0x00bfff, 0x00ffff, 0x8fbc8f, 0x2e8b57, 0x00ff7f, 0x228b57, 0x9acd32, 0x808000, 0xf0e68c, 0xffff00, 0xb8860b, 0x8b4513, 0xff8c00, 0xb22222, 0xff0000, 0xffc0cb, 0xff1493, 0x9932cc ];
const code = ["a","b","c","d","e","f","g","h","j","k","l","m","n","o","p","q","r","s","t","u","v","w","y","z"];
var data;
const input = document.getElementById("upload");
input.onchange = async (ev) => {
  if (input.files && input.files[0]) {
    file = input.files[0];
    image = UPNG.decode(await file.arrayBuffer());
    //quant = UPNG.quantize(image.data,24);
    //console.log(quant.inds);
    rgba8 = UPNG.toRGBA8(image)[0]; // [0] for the first frame
    pixel = new Uint8Array(rgba8);

    table = document.getElementById("table");
    table.innerHTML = "";

    for (var y=0; y<image.height; y++) {
      tr = document.createElement("tr");
      table.appendChild(tr);
      for (var x=0; x<image.width; x++) {
        td = document.createElement("td");
        n = y*image.width*4 + x*4;
        r = image.data[n++] << 16;
        g = image.data[n++] << 8;
        b = image.data[n];
        td.innerHTML = encode(r+g+b) + (x==image.width-1 && y==image.height-1 ?"":",")
        tr.appendChild(td);
      }
    }

    render = document.getElementById("render");
    render.innerHTML = "";

    for (var y=0; y<image.height; y++) {
      tr = document.createElement("tr");
      render.appendChild(tr);
      for (var x=0; x<image.width; x++) {
        td = document.createElement("td");
        n = y*image.width*4 + x*4;
        r = pixel[n++] << 16;
        g = pixel[n++] << 8;
        b = pixel[n];
        c = encode(r+g+b)
        td.innerHTML = "&nbsp;"+ c +"&nbsp;";
        console.log("#"+("00000"+pal[code.indexOf(c)].toString(16)).slice(-6));
        td.style.backgroundColor = "#"+("00000"+pal[code.indexOf(c)].toString(16)).slice(-6);
        tr.appendChild(td);
      }
    }

  }
};

function red(rgb) { return (rgb & 0xff0000)>>16; }
function green(rgb) { return (rgb & 0x00ff00)>>8; }
function blue(rgb) { return (rgb & 0x0000ff); }

function encode(rgb) {
  var i=0;
  var best=0xffffff;
  for (var n=0; n<24; n++) {
    rdiff = Math.abs(red(rgb) - red(pal[n]));
    gdiff = Math.abs(green(rgb) - green(pal[n]));
    bdiff = Math.abs(blue(rgb) - blue(pal[n]));
    diff = Math.sqrt(rdiff + gdiff + bdiff);
    if (diff<best) {
      best = diff;
      i = n;
    }
  }
  return code[i];
}

function palette(c) {
  switch(c) {
    case 0xffffff: return "a"; // White
    case 0x696969: return "b"; // DimGray
    case 0x000000: return "c"; // Black
    case 0x6495ed: return "d"; // CornflowerBlue
    case 0x0000cd: return "e"; // MediumBlue
    case 0x191970: return "f"; // MidnightBlue
    case 0x00bfff: return "g"; // DeepSkyBlue
    case 0x00ffff: return "h"; // Cyan
    case 0x8fbc8f: return "j"; // DarkSeaGreen
    case 0x2e8b57: return "k"; // SeaGreen
    case 0x00ff7f: return "l"; // SpringGreen
    case 0x228b57: return "m"; // ForestGreen
    case 0x9acd32: return "n"; // YellowGreen
    case 0x808000: return "o"; // Olive
    case 0xf0e68c: return "p"; // Khaki
    case 0xffff00: return "q"; // Yellow
    case 0xb8860b: return "r"; // DarkGoldenrod
    case 0x8b4513: return "s"; // SaddleBrown
    case 0xff8c00: return "t"; // DarkOrange
    case 0xb22222: return "u"; // Firebrick
    case 0xff0000: return "v"; // Red
    case 0xffc0cb: return "w"; // Pink
    case 0xff1493: return "y"; // DeepPink
    case 0x9932cc: return "z"; // DarkOrchid
  }
}
</script>
</body>
</html>